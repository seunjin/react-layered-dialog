import { useCallback, useEffect } from 'react';
import { useDialogs } from '@/lib/dialogs';
import type { DialogState } from 'react-layered-dialog';
import type { ConfirmDialogState } from '@/lib/dialogs';
import { Button } from '@/components/ui/button';

type ConfirmProps = DialogState<ConfirmDialogState>;

export const Confirm = ({
  id,
  title,
  message,
  onConfirm,
  onCancel,
  zIndex,
}: ConfirmProps) => {
  const { dialogs, closeDialog } = useDialogs();

  const handleCancel = useCallback(() => {
    onCancel?.();
    closeDialog(id);
  }, [closeDialog, id, onCancel]);

  const handleConfirm = useCallback(() => {
    onConfirm?.();
    closeDialog(id);
  }, [closeDialog, id, onConfirm]);

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      const isTopDialog =
        dialogs.length > 0 &&
        dialogs[dialogs.length - 1].state.id === id;
      if (event.key === 'Escape' && isTopDialog) {
        handleCancel();
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [dialogs, handleCancel, id]);

  return (
    <div
      className="fixed inset-0 flex items-center justify-center bg-black/40"
      style={{ zIndex }}
      role="dialog"
      aria-modal="true"
      aria-labelledby={`confirm-${id}-title`}
      aria-describedby={`confirm-${id}-message`}
      onClick={handleCancel}
    >
      <div
        className="min-w-[300px] rounded-lg bg-white p-6 shadow-lg"
        onClick={(event) => event.stopPropagation()}
      >
        <h3 id={`confirm-${id}-title`} className="text-lg font-semibold">
          {title}
        </h3>
        <p
          id={`confirm-${id}-message`}
          className="mt-2 text-sm text-muted-foreground"
        >
          {message}
        </p>
        <div className="mt-4 flex justify-end gap-2">
          <Button variant="outline" onClick={handleCancel}>
            취소
          </Button>
          <Button autoFocus onClick={handleConfirm}>
            확인
          </Button>
        </div>
      </div>
    </div>
  );
};
